@page "/arvfordeling"
@rendermode InteractiveServer

<PageTitle>Fordeling af arv</PageTitle>

<div>
    <ul>
        @foreach(Inheritor inheritor in inheritors)
        {
            <li>
                <Check 
                    TValue="bool" 
                    Checked="@(removedInheritors.Any(i => i.Id == inheritor.Id))"
                    CheckedChanged="() => handleInheritorCheck(inheritor)"
                >
                    @inheritor.Name: 
                    @(calculateForcedInheritance(inheritor) + calculateFreeInheritance(inheritor))
                </Check>
            </li>
        }
    </ul>

    <div class="col-6">
    <Chart Type="ChartType.Pie" @ref=pieChart TItem="double"/>
    </div>
</div>

@code
{
    private List<Inheritor> inheritors = InheritorRepository.GetInheritors();
    private List<Inheritor> removedInheritors = new List<Inheritor>()
    {
        new Inheritor{Id = 2, Name = "Gustav", InheritorType = InheritorType.Type1}
    };
    private int numberOfFreeInheritors = InheritorRepository.GetInheritors().Sum(i => i.InheritsFreeInheritance ? 1 : 0);

    private int fullInheritance = 100;

    private Chart<double> pieChart = new Chart<double>();
    List<string> backgroundColors = new List<string>
    {
        ChartColor.FromRgba(255, 70, 70, 0.8f),
        ChartColor.FromRgba(70, 130, 255, 0.8f),
        ChartColor.FromRgba(255, 220, 70, 0.8f),
        ChartColor.FromRgba(70, 255, 135, 0.8f),
        ChartColor.FromRgba(185, 70, 255, 0.8f),
        ChartColor.FromRgba(255, 140, 50, 0.8f)
    };
    ChartOptions chartOptions = new() { AspectRatio = 1.5 };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await handleRedraw();
        }
    }

    private async Task handleRedraw()
    {
        await pieChart.Clear();

        await pieChart.AddLabelsDatasetsAndUpdate(getPieChartLabels(), getPieChartDataset());
    }

    private async Task handleInheritorCheck(Inheritor inheritor)
    {
        Inheritor? removedInheritor = removedInheritors.Find(ri => ri.Id == inheritor.Id);

        if (removedInheritor != null)
        {
            removedInheritors.Remove(removedInheritor);
            await handleRedraw();
            return;
        }

        removedInheritors.Add(inheritor);
        await handleRedraw();
    }

    private double calculateForcedInheritance(Inheritor inheritor) 
    {
        double forcedInheritance = fullInheritance / 4;
        List<Inheritor> inheritorsWithInheritanceClassOne = inheritors.Where(i => i.InheritorType == InheritorType.Type1 && !removedInheritors.Any(ri => ri.Id == i.Id)).ToList();
        List<Inheritor> inheritorsWithInheritanceClassTwo = inheritors.Where(i => i.InheritorType == InheritorType.Type2 && !removedInheritors.Any(ri => ri.Id == i.Id)).ToList();
        List<Inheritor> inheritorsWithInheritanceClassThree = inheritors.Where(i => i.InheritorType == InheritorType.Type3 && !removedInheritors.Any(ri => ri.Id == i.Id)).ToList();

        if(inheritorsWithInheritanceClassOne.Contains(inheritor)) 
        {
            return forcedInheritance / inheritorsWithInheritanceClassOne.Count;
        } 
        else if (inheritorsWithInheritanceClassOne.Count == 0 && inheritorsWithInheritanceClassTwo.Contains(inheritor)) 
        {
            return forcedInheritance / inheritorsWithInheritanceClassTwo.Count;
        } 
        else if (inheritorsWithInheritanceClassOne.Count == 0 && inheritorsWithInheritanceClassTwo.Count == 0) 
        {
            return forcedInheritance / inheritorsWithInheritanceClassThree.Count;
        } 
        else 
        {
            return 0;
        }
    }

    private double calculateFreeInheritance(Inheritor inheritor)
    {
        double freeInheritance = fullInheritance * 3 / 4;

        if (inheritor.InheritsFreeInheritance)
        {
            return freeInheritance / numberOfFreeInheritors;
        }
        else
        {
            return 0;
        }
    }

    private PieChartDataset<double> getPieChartDataset()
    {
        return new PieChartDataset<double>
        {
            Label = "Fordeling af arv",
            Data = inheritors.Where(i => !removedInheritors.Any(ri => ri.Id == i.Id))
                .Select(i => calculateForcedInheritance(i) + calculateFreeInheritance(i))
                .ToList(),
            BackgroundColor = backgroundColors
        };
    }

    private List<string> getPieChartLabels()
    {
        return inheritors.Where(i => !removedInheritors.Any(ri => ri.Id == i.Id))
            .Select(i => i.Name ?? "")
            .ToList();
    }
}